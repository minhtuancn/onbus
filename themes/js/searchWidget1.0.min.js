function closeSelector() {
    $(".place-selector").hide()
}

function searchTickets() {
    if (!$.isNumeric($("#start-point-id").val())) return $("#departPlace").trigger("focus"), !1;
    if (!$.isNumeric($("#stop-point-id").val())) return $("#destination").trigger("focus"), !1;
    var a = $("#departDate").val();
    null != a && (a = a.replace(/\//gi, "-"));
    if (null == a || "" == a) return $("#departDate").trigger("focus"), !1;
    var b = locdau($("#departPlace").val()),
        c = locdau($("#destination").val());
    "ho-chi-minh" == b && (b = "sai-gon");
    "ho-chi-minh" == c && (c = "sai-gon");
    var e = $("#search-busoperator-id").val(),
        f = locdau($("#search-busoperator-name").val()),
        d = "/ve-xe-khach",
        d = 0 < e ? d + ("-" + f + "-tu-" + b + "-di-" + c + "-ngay-" + a + "-") : d + ("-tu-" + b + "-di-" + c + "-ngay-" + a + "-"),
        a = $("#start-point-type").val(),
        b = $("#start-point-id").val(),
        c = $("#stop-point-type").val(),
        f = $("#stop-point-id").val(),
        g = $("#passengerNum").val();
    "" == g && (g = 1);
    "" != a && "" != b && "" != c && "" != f && (d = 0 < e ? d + String.format("{0}{1}t{2}{3}{4}-{5}.html", a, b, c, f, g, e) : d + String.format("{0}{1}t{2}{3}{4}.html", a, b, c, f, g), showLoading(), location.href = "/vi-VN" + d);
    return !1
}

function clickOutsideSelector(a) {
    $(document).mouseup(function(b) {
        var c = $(a),
            e = c.prev();
        !c.is(":visible") || e.is(":focus") || c.is(b.target) || 0 !== c.has(b.target).length || c.hide()
    })
}

function maskEventOnDepartureInput() {
    $("#departPlace").focus(function() {
        closeSelector();
        $(this).next("#departPlaceSelector").css("display", "block")
    });
    $("#departPlace").keypress(function(a) {
        //alert(a.keyCode);
        13 == a.keyCode ? $(this).val() ? $("#destination").focus() : $(this).focus() : closeSelector();
    });
    $("#departPlace").catcomplete({
        autoFocus: !0,
        delay: 0,
        source: function(a, b) {
            var c = slug(a.term);            
            console.log(c);
            b($.map(statecity, function(a) {
                var b = slug(a.label);
                if (0 === b.indexOf(c)) return a
            }))
        },
        select: function(a, b) {
            $("#departPlace").val(b.item.label);                  
            $("#vstart").val(b.item.StateId); 
            $.ajax({
                url: "ajax/destination.php",
                type: "POST",
                async: false,
                 dataType: "json",
                data: {"vstart":b.item.StateId,"type":1},
                success: function(data){                    
                    $('#destinationSelector').html(data.str1);
                }
            });
            $.ajax({
                url: "ajax/destination.php",
                type: "POST",
                async: false,
                 dataType: "json",
                data: {"vstart":b.item.StateId,"type":3},
                success: function(data){               
                    $('#scr').html(data.str1);
                    $("#destination").catcomplete({
                    autoFocus: !0,
                    delay: 0,
                    source: function(a, b) {
                        var c = slug(a.term);
                        b($.map(statecity2, function(a) {
                            var b = slug(a.label);
                            if (0 === b.indexOf(c)) return a
                        }))
                    },
                    select: function(a, b) {
                        $("#destination").val(b.item.label);                                  
                         $("#vend").val(b.item.StateId);            
                        
                        $("#departDate").focus();
                        return !1
                    }
                })                   
                }
            });

              
            $("#destination").focus();

            return !1
        }
    });
}

function maskEventOnDestinationInput() {
    $("#destination").focus(function() {
        closeSelector();
        $(this).next("#destinationSelector").css("display", "block");
    });
    $("#destination").keypress(function(a) {
        13 == a.keyCode ? $(this).val() ? $("#departDate").focus() : $(this).focus() : closeSelector();
    });
    $("#destination").catcomplete({
        autoFocus: !0,
        delay: 0,
        source: function(a, b) {
            var c = slug(a.term);
            b($.map(statecity, function(a) {
                var b = slug(a.label);
                if (0 === b.indexOf(c)) return a
            }))
        },
        select: function(a, b) {
            $("#destination").val(b.item.label);                 
             $("#vend").val(b.item.StateId);                      
            $("#departDate").focus();
            return !1
        }
    })
}

function maskEventOnDepartTimeInput() {
    $("#departDate").datepicker({
        minDate: new Date,
        numberOfMonths: 2,
        onSelect: function() {
            var a = Math.abs(new Date - $(this).datepicker("getDate")),
                a = Math.round(a / 864E5);
            $(this).datepicker("getDate") > $("#returnDate").datepicker("getDate") && $("#returnDate").datepicker("option", "minDate", a + 1);

            var dstart = $.trim($('#departDate').val());
            var vstart = $('#vstart').val();
            var vend = $('#vend').val();
            if(dstart != ''){
                $.ajax({
                    url: "ajax/car.php",
                    type: "POST",
                    async: false,                         
                    data: {"vstart":vstart,"vend":vend,"dstart":dstart},
                    success: function(data){                    
                        $('#car').html(data);
                    }
                });
            }

        }
    });
    $("#departDate").focus(function() {
        closeSelector();
    })
}

function maskEventOnDestinationTimeInput() {
    $("#returnDate").datepicker({
        minDate: new Date,
        numberOfMonths: 2
    });
    $("#returnDate").focus(function() {
        closeSelector();
    })
}

function maskEventOnNumTicketSelect() {
    $("#passengerNum").customSelect();
}

function maskEventOnSelectStatePopup() {
    $("li.city > a").click(function() {
        var a = $(this).parent().parent().parent().parent().parent(),
            b = $(this).attr("data-state");
            if(a.attr("id") == "departPlaceSelector"){
                $("#departPlace").val($(this).text());        
                $("#vstart").val(b);
                $("#destination").focus(); 
                $.ajax({
                    url: "ajax/destination.php",
                    type: "POST",
                    async: false,
                     dataType: "json",
                    data: {"vstart":b,"type":1},
                    success: function(data){                    
                        $('#destinationSelector').html(data.str1);
                    }
                });
            }
            if(a.attr("id") == "destinationSelector"){
                $("#destination").val($(this).text()); 
                $("#vend").val(b);            
                $("#departDate").focus();
            }         
        return !1
    });
    $("a.close").click(function() {
        closeSelector();
    });
    clickOutsideSelector("#departPlaceSelector");
    clickOutsideSelector("#destinationSelector");
}

function trackingGoogleAnalytics() {
    ga("send", "event", "button", "click", "Search Ticket")
}
function showLoading(){jQuery(".vxr-loading-overlay").height($(window).height()).show();jQuery(".vxr-loading-overlay img").css("margin-top",($(window).height()-75)/2+"px")}function hideLoading(){jQuery(".vxr-loading-overlay").hide()};

function maskEventOnSearchButton() {
    $("#searchSubmit").click(function() {
        trackingGoogleAnalytics();
        searchTickets();
    });
    $("#searchSubmit").keypress(function(a) {
        13 == a.keyCode && searchTickets();
    })
}

function initSearchTicketWidget() {
    maskEventOnDepartureInput();
    maskEventOnDestinationInput();
    maskEventOnDepartTimeInput();
    maskEventOnDestinationTimeInput();
    maskEventOnNumTicketSelect();
    maskEventOnSelectStatePopup();
    maskEventOnSearchButton();    
};
$(function(){
    $('#btnSearch').click(function(){
      var noidi = $('#departPlace').val();
      var noiden = $('#destination').val();  
      var type = $('input[name="ticket-type"]:checked').val();      
      var vstart = $('#vstart').val();
      var vend = $('#vend').val();
      var dstart = $.trim($('#departDate').val());
      var dend = $.trim($('#returnDate').val());
      if(vstart >0 ){
          if(vend > 0){
              if(dstart !=''){
                   var url = "index.php?mod=search&type="+ type +"&vstart=" + vstart + "&vend=" + vend + "&dstart=" + dstart ;
                   var strSubmit = "ve-xe-khach-di-tu "+ noidi + " den " + noiden + " ngay " + dstart;
                   strSubmit = tripunicode(strSubmit) + "-" + type+"s"+vstart+"e"+vend;
                   var car = $("#car").val();
                   if(car > 0){
                        url+= "&car=" + car;
                        strSubmit +="c"+car;                   
                   }   
                   if(type==2){
                        if(dend != ''){
                            url+= "&dend=" + dend;
                        }else{
                            $('#returnDate').focus();return false;                            
                        }
                   }
                   //alert(strSubmit);
                   showLoading();
                   location.href=url;
                   

              }else{
                  $('#departDate').focus();return false;
              }
          }else{
              $('#destination').focus();return false;
          }
      }else{
          $('#departPlace').focus();return false;
      }
  });
});
